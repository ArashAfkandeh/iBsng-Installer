# نصب آسان iBsng به همراه ربات پشتیبان‌گیر تلگرام

<div dir="rtl">

## 🌟 معرفی

این پروژه یک راهکار کامل و خودکار برای **نصب، مدیریت و پشتیبان‌گیری از سرویس IBSng** با استفاده از Docker است که با یک ربات تلگرام ادغام شده است. با این ابزار می‌توانید به راحتی سرویس IBSng را راه‌اندازی کرده و از پایگاه داده آن به صورت منظم و خودکار نسخه پشتیبان تهیه کنید. فایل‌های پشتیبان به طور مستقیم به چت تلگرام شما ارسال می‌شوند و شما می‌توانید از طریق دستورات ربات، عملیات پشتیبان‌گیری و بازیابی را مدیریت کنید.

## 🎯 ویژگی‌های کلیدی

- ✅ **نصب تمام خودکار**: اسکریپت نصب هوشمند که تمام پیش‌نیازها از جمله Docker، Docker Compose و ابزارهای Python را بر روی سرور شما نصب می‌کند.
- ⚙️ **پیکربندی تعاملی**: در هنگام نصب، پورت‌های مورد نیاز (وب، RADIUS) و اطلاعات ربات تلگرام به صورت تعاملی از شما دریافت می‌شود.
- 💾 **ذخیره‌سازی پایدار داده‌ها**: تمامی اطلاعات پایگاه داده PostgreSQL در مسیر `/opt/ibsng/pgsql` بر روی هاست ذخیره می‌شود تا با حذف یا آپدیت کانتینر از بین نرود.
- 🤖 **ادغام کامل با تلگرام**:
  - **ارسال خودکار بکاپ**: فایل‌های پشتیبان به صورت خودکار و با کپشن تاریخ شمسی به چت یا کانال تلگرام شما ارسال می‌شوند.
  - **ربات مدیریتی**: با دستورات ساده به ربات، سرویس خود را مدیریت کنید.
  - **پیکربندی پویا**: حداقل فاصله زمانی بین بکاپ‌ها را مستقیماً از طریق دستورات ربات تغییر دهید.
- 🔄 **پشتیبان‌گیری هوشمند**:
  - **زمان‌بندی خودکار**: بکاپ‌گیری در فواصل زمانی مشخص (قابل تنظیم) به صورت خودکار انجام می‌شود.
  - **کنترل فاصله زمانی**: جلوگیری از بکاپ‌های مکرر برای حفظ منابع سیستم.
  - **بکاپ‌گیری دستی**: هر زمان که بخواهید، با دستور `/backup` یک نسخه پشتیبان جدید ایجاد کنید.
- 🚀 **بازیابی آسان و سریع**:
  - **بازیابی از طریق تلگرام**: فایل بکاپ را برای ربات ارسال کنید تا عملیات بازیابی به صورت خودکار انجام شود.
  - **شناسایی هوشمند فرمت**: اسکریپت به طور خودکار فرمت‌های مختلف بکاپ (`.dump.gz` سفارشی یا `.bak` متنی) را تشخیص می‌دهد.
- 📊 **بررسی وضعیت**: با دستور `/status` از وضعیت آخرین بکاپ و زمان آن مطلع شوید.
- 🛡️ **سرویس پایدار Systemd**: اسکریپت پشتیبان‌گیری به عنوان یک سرویس دائمی (`ibsng-backup.service`) در پس‌زمینه اجرا می‌شود تا همیشه فعال بماند و در صورت بروز مشکل به طور خودکار ری‌استارت شود.
-  firewall **پیکربندی خودکار فایروال**: در صورت فعال بودن UFW، پورت‌های مورد نیاز به طور خودکار باز می‌شوند.
- 🗑️ **مدیریت خودکار فایل‌ها**: فایل‌های بکاپ محلی پس از ارسال موفق به تلگرام به طور خودکار حذف می‌شوند تا فضای دیسک اشغال نشود.

## 📋 نیازمندی‌ها

- **سیستم عامل**: **Ubuntu 22.04**
- **دسترسی**: دسترسی `root` یا کاربری با دسترسی `sudo`.

## ⚡ نصب و راه‌اندازی

برای نصب، دستور زیر را در ترمینال سرور خود اجرا کنید. این دستور اسکریپت نصب را دانلود و اجرا می‌کند:

```bash
curl -sSL https://raw.githubusercontent.com/ArashAfkandeh/iBsng-Installer/main/install_ibsng.sh | sudo bash
```

### مراحل نصب چه کاری انجام می‌دهد؟

1.  **بررسی دسترسی**: اطمینان از اجرای اسکریپت با دسترسی `root`.
2.  **نصب پیش‌نیازها**: نصب Docker، Docker Compose، Git، Python و سایر بسته‌های ضروری.
3.  **پیکربندی تعاملی**: از شما برای تنظیم پورت‌های وب و RADIUS و همچنین توکن و شناسه چت ربات تلگرام سوال می‌شود. (برای رد کردن می‌توانید Enter بزنید).
4.  **راه‌اندازی کانتینر**: دانلود ایمیج IBSng و راه‌اندازی آن با استفاده از `docker-compose` و `network_mode: "host"`.
5.  **ایجاد سرویس بکاپ**: یک سرویس `systemd` به نام `ibsng-backup.service` برای اجرای دائمی اسکریپت مدیریت بکاپ ایجاد و فعال می‌شود.
6.  **پیکربندی فایروال**: در صورت فعال بودن `UFW`، پورت‌های انتخابی شما باز می‌شوند.
7.  **نمایش اطلاعات نهایی**: در پایان، آدرس دسترسی به پنل وب IBSng و اطلاعات پورت‌ها نمایش داده می‌شود.

### نصب غیرتعاملی (Non-Interactive)

برای نصب خودکار بدون سوالات تعاملی، می‌توانید تمام پارامترها را مستقیماً در خط فرمان به اسکریپت ارسال کنید.

**فرمت کلی دستور:**

```bash
curl -sSL https://raw.githubusercontent.com/ArashAfkandeh/iBsng-Installer/main/install_ibsng.sh | sudo bash -s -- [WEB_PORT] [AUTH_PORT] [ACCT_PORT] [TOKEN] [CHAT_ID]
```

**مثال کامل:**

```bash
curl -sSL https://raw.githubusercontent.com/ArashAfkandeh/iBsng-Installer/main/install_ibsng.sh | sudo bash -s -- '80' '1812' '1813' '123456:ABC-DEF123456' '-100123456789'
```

**توضیح پارامترها:**

| پارامتر | توضیحات | مقدار پیش‌فرض |
| :--- | :--- | :--- |
| `WEB_PORT` | پورت TCP برای دسترسی به پنل وب IBSng. | `80` |
| `AUTH_PORT` | پورت UDP برای احراز هویت کاربران (RADIUS Authentication). | `1812` |
| `ACCT_PORT` | پورت UDP برای حسابرسی (RADIUS Accounting). | `1813` |
| `TOKEN` | توکن ربات تلگرام شما. | (خالی) |
| `CHAT_ID` | شناسه چت (عددی) کاربر یا کانالی که بکاپ‌ها به آن ارسال می‌شود. | (خالی) |

**نکات مهم:**
- اگر پارامتری را ارائه ندهید، مقدار پیش‌فرض آن استفاده خواهد شد.
- برای استفاده از مقادیر پیش‌فرض برای پورت‌ها و در عین حال تنظیم تلگرام، می‌توانید به جای پورت‌ها مقدار خالی (`''`) قرار دهید، اما این روش توصیه نمی‌شود. بهتر است همیشه مقادیر را به صراحت مشخص کنید.

## 🛠️ پیکربندی ربات تلگرام

اگر در حین نصب اطلاعات ربات را وارد نکرده‌اید یا قصد تغییر آن را دارید، فایل زیر را ویرایش کنید:

**مسیر فایل:** `/opt/ibsng/backup_ibsng/config.json`

محتوای فایل باید به شکل زیر باشد:

```json
{
    "bot_token": "7816664753:AAGWV-tTGRoFrTsYjJS0dMRDeAEF-clVmEs",
    "chat_id": "5062027097",
    "min_interval_hours": 24,
    "last_backup": 1754370577.5221798
}
```

- `bot_token`: توکن ربات تلگرام که از [@BotFather](https://t.me/BotFather) دریافت می‌کنید.
- `chat_id`: شناسه عددی چت، کاربر یا کانالی که می‌خواهید بکاپ‌ها به آنجا ارسال شود. (برای دریافت به [@chatIDrobot](https://t.me/chatIDrobot) مراجعه کنید).

پس از ذخیره فایل، سرویس بکاپ را ریستارت کنید تا تغییرات اعمال شوند:

```bash
sudo systemctl restart ibsng-backup.service
```

## 🎮 دستورات ربات تلگرام

شما می‌توانید با ارسال دستورات زیر به ربات تلگرام خود، سرویس را مدیریت کنید. **توجه**: این دستورات فقط برای کاربری که `chat_id` او در فایل کانفیگ ثبت شده، قابل استفاده است.

| دستور | توضیحات |
| :--- | :--- |
| `/status` | **نمایش وضعیت**: زمان آخرین بکاپ و حداقل فاصله زمانی تنظیم شده بین بکاپ‌ها را نمایش می‌دهد. |
| `/backup` | **شروع عملیات پشتیبان‌گیری دستی**: بلافاصله یک نسخه پشتیبان جدید از پایگاه داده تهیه و به تلگرام ارسال می‌کند. |
| `/restore` | **شروع عملیات بازیابی**: ربات از شما می‌خواهد فایل بکاپ (`.dump.gz` یا `.bak`) را ارسال کنید تا پایگاه داده را بازیابی کند. |
| `/time <ساعت>` | **تنظیم فاصله بکاپ**: حداقل فاصله زمانی بین بکاپ‌های خودکار را (به ساعت) تغییر می‌دهد. مثال: `/time 8` |
| `/cancel` | **لغو عملیات**: فرآیند بازیابی را در صورتی که منتظر دریافت فایل باشد، لغو می‌کند. |

### نمونه تعامل با ربات

**درخواست بکاپ دستی:**

> **User:** `/backup`
>
> **Bot:** `🔄 در حال شروع عملیات بکاپ‌گیری...`
>
> **Bot:** _(فایل بکاپ با کپشن تاریخ و زمان ارسال می‌شود)_

**درخواست بازیابی:**

> **User:** `/restore`
>
> **Bot:** `⚠️ هشدار بسیار مهم: ... لطفاً فایل بکاپ معتبر را ارسال کنید.`
>
> **User:** _(فایل `IBSng_backup_2024-01-01.dump.gz` را ارسال می‌کند)_
>
> **Bot:** `🔄 در حال شروع عملیات بازیابی دیتابیس...`
>
> **Bot:** _(گزارش مراحل بازیابی را ارسال می‌کند)_
>
> **Bot:** `✅ بازیابی پایگاه داده با موفقیت انجام شد!`

## 🔧 مدیریت سرویس

### مدیریت سرویس بکاپ (ibsng-backup.service)

- **مشاهده وضعیت سرویس:**
  ```bash
  sudo systemctl status ibsng-backup.service
  ```
- **مشاهده لاگ‌های سرویس بکاپ:**
  ```bash
  journalctl -u ibsng-backup.service -f
  ```
- **ری‌استارت کردن سرویس:**
  ```bash
  sudo systemctl restart ibsng-backup.service
  ```

### مدیریت کانتینر IBSng

برای مدیریت کانتینر IBSng، به مسیر `/opt/ibsng` بروید و از دستورات `docker compose` استفاده کنید:

```bash
cd /opt/ibsng
```

- **مشاهده لاگ‌های کانتینر IBSng:**
  ```bash
  docker compose logs -f
  ```
- **متوقف کردن سرویس IBSng:**
  ```bash
  docker compose down
  ```
- **راه‌اندازی مجدد سرویس IBSng:**
  ```bash
  docker compose up -d
  ```

## 📄 مجوز (License)

این پروژه تحت مجوز **MIT** منتشر شده است. برای اطلاعات بیشتر فایل `LICENSE` را مطالعه کنید.

</div>
